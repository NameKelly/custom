<!DOCTYPE html>
<html>
<head>
    <title>商城</title>
    <meta name="viewpoint" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=no,width=device-width,initial-scale=1.0" />
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="./css/mall_2.css">
    <link rel="stylesheet" type="text/css" href="./css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="./css/bootstrap_alert.css">
    <link rel="stylesheet" type="text/css" href="./css/swiper.min.css">
    <script src="http://code.jquery.com/jquery-1.8.0.min.js"></script>
    <!--<script src="Scripts/jquery.cookie.js" type="text/javascript"></script>-->
    <script src="Scripts/jquery.form.js" type="text/javascript"></script>
    <script src="Scripts/json2.js" type="text/javascript"></script>
    <script src="Scripts/bootstrap_alert.js" type="text/javascript"></script>
    <script src="Scripts/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="Scripts/MJ_JSComment.js" type="text/javascript"></script>
    <script src="Scripts/jquery.cookie.min.js" type="text/javascript"></script>
    <script src="Scripts/myStorage.js" type="text/javascript"></script>
    <script src="Scripts/Convert_Pinyin.js" type="text/javascript"></script>
    <script src="Scripts/countDown.js" type="text/javascript"></script>
    <script src="Scripts/noZoom.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://cdn.bootcss.com/vConsole/3.3.0/vconsole.min.js"></script>
    <!--<script>
        var vConsole = new VConsole();
        console.log('Hello world');
    </script>-->


    <style>
        .noData {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: white;
            flex-direction: column;
        }

        .noDataItem {
            width: 500px;
            height: 400px;
            margin-top: 300px;
        }

        .noSeeItem {
            width: 300px;
            height: 300px;
            margin-top: 400px;
        }

        .noSeeText {
            line-height: 300px;
            font-size: 80px;
            color: #CCCCCC;
        }
    </style>

</head>
<body id="body">
    <div id="bigBox">
        <!--<header>
            <figure><img src="img/back.png"></figure>
            <figcaption>商城</figcaption>
            <figure class="img1"><img src="img/more.png"></figure>
        </header>-->
        <div id="tab" class="swiper-container" style="position: relative">
            <ul id="list" class="swiper-wrapper">
                <li class="swiper-slide" id="myOrder">我的订单</li>
            </ul>
        </div>
        <div class="clear"></div>

        <section id="section">
            <!-- 肉类 -->
            <div class="show divclass order">

            </div>

            <!-- 蔬菜类 -->
            <div class="divclass order">

            </div>

            <!-- 饮料 -->
            <div class="divclass order">

            </div>

            <!-- 水果 -->
            <div class="divclass order">

            </div>

            <!--我的订单-->
            <div class="divclass order">

            </div>
            <!--add-->
            <div class="divclass order"></div>
            <div class="divclass order"></div>
            <div class="divclass order"></div>
            <div class="divclass order"></div>
            <div class="divclass order"></div>

            <div class="divclass order"></div>
            <div class="divclass order"></div>
            <div class="divclass order"></div>
            <div class="divclass order"></div>
            <div class="divclass order"></div>

            <div class="divclass order"></div>
            <div class="divclass order"></div>
            <div class="divclass order"></div>
            <div class="divclass order"></div>
            <div class="divclass order"></div>
            <div class="divclass order"></div>
        </section>
        <!--<footer>
            <input type="button" name="" value="前往下单" onclick="go_order2()">
        </footer>-->    
        <div class="footer" style="position: absolute;bottom: 10px;width: 100%;text-align: center;z-index: 999;margin: 0">
            <input type="button" style="width: 80%;background-color: #199ed8;font-size: 50px;padding: 10px;color: white;-webkit-border-radius: 20px;z-index: 999; margin-top: 100px" value="前往下单" onclick="go_order2()">
        </div>
    </div>
    
    <script type="text/javascript">
        ////跳转参数
        //var url = location.search; //获取url中"?"符后的字串 ('?modFlag=business&role=1')
        //var theRequest = new Object();
        //if (url.indexOf("?") != -1) {
        //    var str = url.substr(1); //substr()方法返回从参数值开始到结束的字符串；
        //    var strs = str.split("&");
        //    for (var i = 0; i < strs.length; i++) {
        //        theRequest[strs[i].split("=")[0]] = (strs[i].split("=")[1]);
        //    }
        //    console.log(theRequest); //此时的theRequest就是我们需要的参数；
        //    var li = document.getElementsByTagName('li');//获取菜单列表
        //    var li_content = document.getElementsByClassName('divclass');//获取菜单对应内容
        //    li[0].className = '';
        //    li_content[0].style.display = 'none'
        //    li[4].className = theRequest.data;
        //    li_content[4].style.display = 'block'
        //}
       
        $(document).ready(function () {
            var code = GetQueryString("code") || myStorage.getItem('code');
            //var code = GetQueryString("code");

            //noData('body')//本地测试
            //select_menuName();//本地测试
            //myStorage.setItem('mallPhone', '13686948977');//本地测试
            if (code != null && code.toString().length > 1) {
                var jsonObj = {
                    code: code
                };
                poststr = JSON.stringify(jsonObj);
                mj_ajax("api/getData", "json", poststr, callback_getdata);
            }
            else {
                //本地测试
                //select_menuName();
            }

        });
        //提交订单数据
       
        function go_order2() {
            let result = [];
            let section = document.getElementById('section');
            let ids = section.getElementsByClassName('divclass order');
            for (let i = 0; i < ids.length; i++) {
                let names = ids[i].getElementsByClassName('name');
                let countNum = ids[i].getElementsByClassName('countNum');
                for (let j = 0; j < names.length; j++) {
                    var num = countNum[j].value;
                    var name = names[j].innerText;
                    let postID = names[j].title;
                    result.push({
                        postID: postID,
                        quantity: num
                    })
                    console.log("result", result)
                }
            }
            send_arr(result);
        }
        function send_arr(result) {

            let mallPhone = myStorage.getItem('mallPhone');
            let data = result.filter(item => item.quantity * 1 > 0); //苹果不兼容箭头函数?
            console.log("send_arr", result, data);
            if (JSON.stringify(data) != '[]') {
                $.ajax({
                    type: "post",
                    url: "api/add_order",
                    data: {
                        phone: mallPhone,
                        //phone: '13686948977',
                        record: JSON.stringify(data)
                    },
                    traditional: true,
                    success: function (res) {
                        var arr = JSON.parse(res);


                        if (arr.msg == '录入成功') {
                            //alert('录入成功');
                            window.location.href = "./sure_order.html?data=" + arr.data;
                        } else {
                            alert(arr.msg);
                        }

                    }
                });
            } else {
                alert('请选择商品!');
            }
        }

        //function _success() {
        //    zeroModal.success('预定商品成功!');
        //    window.location.href = "./sure_order.html?data=" + arr.data;
        //}
        function callback_getdata(data) {
            //myStorage.setItem('mallPhone', '13686948977');//本地测试
            
            if (myStorage.getItem('mallPhone')) {

                select_menuName();

            } else {
                console.log("data", data);
                //alert(data.msg);
                if (data.msg == "成功查询!") {
                    let mallPhone = data.data;
                    myStorage.setItem('mallPhone', mallPhone);
                    phone = myStorage.getItem('mallPhone');

                    select_menuName();
                }
                else {
                    //alert(data.msg);
                    let div = document.createElement('div');
                    div.innerHTML = '<div class="noData" style="margin-top:100px;"><img class="noSeeItem" src="./img/noSee.png"/><p id="noSeeText" class="noSeeText">无权访问</p></div>';
                    $("#body").html(div);
                    document.getElementById('noSeeText').innerHTML = data.msg;

                }
            }

        }
        //获取菜单
        function select_menuName() {
            //alert("获取菜单接口");
            $.ajax({
                type: "post",
                url: "api/select_menuName",
                data: { menu_type: "menu_type" },
                success: function (data) {
                    let datas = JSON.parse(data);
                    let menu = datas.data;
                    console.log("menu", data, menu);
                    if (menu != '') {
                        menu.map(function (v, index) {
                            console.log(v.goods_type)
                            addMenu(v.goods_type, index);
                            select_menu(v.goods_type)
                        })
                    } else {
                        noData('bigBox', 'key2')
                    }

                }
            });
        }
        //菜单渲染
        function addMenu(key, index) {
            let list = document.getElementById('list');
            let myOrder = document.getElementById('myOrder');
            let section = document.getElementById('section');
            let sectionDiv = section.getElementsByClassName('divclass order');
            let li = document.createElement('li');
            if (index == 0) {
                li.className = "liactive swiper-slide";
            } else {
                li.className = "swiper-slide";
            }

            sectionDiv[index].id = Convert_Pinyin(key);
            li.innerHTML = key;
            list.insertBefore(li, myOrder);
            swiper();
            menuActive();
        }
        //id
        function Convert_Pinyin(key) {
            let ids = pinyin.getCamelChars(key);
            return ids;
        }
        //切换菜单
        function menuActive() {
            var li = document.getElementsByTagName('li');//获取菜单列表
            var li_content = document.getElementsByClassName('divclass');//获取菜单对应内容
            li_content[0].style.display = 'block';
            for (let i = 0; i < li.length; i++) {

                li[i].index = i;
                li[i].onclick = function () {
                    for (let j = 0; j < li.length; j++) {
                        li[j].className = 'swiper-slide';
                        li_content[j].style.display = 'none'
                    }
                    li_content[this.index].style.display = 'block';
                    li[this.index].className = 'liactive swiper-slide';
                    if (i == li.length - 1) {
                        window.location.href = "./my_order.html";
                    }
                }
            }
        }
        //获取当前地址中的参数
        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) {
                myStorage.setItem('code', unescape(r[2]));
                return unescape(r[2]);
            }

            return null;
        }

        function select_menu(key) {
            let ids = Convert_Pinyin(key);
            $.ajax({
                type: "post",
                url: "api/select_menu",
                data: { goods_type: key },

                success: function (data) {

                    var jsonData = JSON.parse(data);
                    console.log('数据', jsonData.data);
                    meat_List = jsonData.data;

                    //2019-11-10
                    for (let i = 0; i < meat_List.length; i++) {
                        if (meat_List.length) {
                            getList(meat_List, ids, key, i);
                        } else {
                            noData(ids);
                        }
                    }



                }
            });
        }

        function noData(key, key2) {
            console.log("暂无数据", key);


            var type = document.getElementById(key);
            console.log("type", type)
            if (key2) {
                type.innerHTML = '<div class="noData" style="margin-top:100px;"><img class="noDataItem" src="./img/noData.png"/><p class="noSeeText">暂无数据</p></div>';
                return;
            }


            let div = document.createElement('div');
            div.innerHTML = '<div class="noData" style="margin-top:100px;"><img class="noDataItem" src="./img/noData.png"/><p class="noSeeText">暂无数据</p></div>';
            type.appendChild(div);

        }

        function getList(meat_List, ids, key, i) {
            console.log(meat_List, ids, key)
            let meat = document.getElementById(ids);
            var money = meat.getElementsByClassName('money');
            var images = meat.getElementsByClassName('img');
            var names = meat.getElementsByClassName('name');
            var time = meat.getElementsByClassName('time');
            var kg = meat.getElementsByClassName('kg');
            var allS = meat.getElementsByClassName('allS');

            var table = document.createElement('table');
            table.className = "td1";
            table.innerHTML = "<tr>\n" +
                "\t\t\t<td style='width:35%'><img src=\"\" class=\"img\" style='width:95%;padding-left: 20px;'></td>\n" +
                "\t\t\t<td style='width:30%'>\n" +
                "\t\t\t\t<div class=\"name\"></div>\n" +
                "\t\t\t\t<div class='allS' style='display:inline-block;'><span class=\"money\"></span><span>元/<span class='kg'></span></span></div></td>\n" +
                "\t\t\t<td style='width:35%'><div class=\"yd counttime2\"><p class='txt txt2'>预定倒计时</p><p style='font-weight: bolder;font-size: 35px;'><span class='time'>00:00:00</span></p></div>\n" +
                "\t\t\t\t<div class=\"count\">\n" +
                "\t\t\t\t<input type=\"button\" class=\"jian countnormal\" value=\"-\" onclick=\"jian(this)\">\n" +
                "\t\t\t\t<input type=\"text\" value=\"0\" class=\"countnormal countNum\">\n" +
                "\t\t\t\t<input type=\"button\" class=\"jia countnormal\" value=\"+\" onclick=\"jia(this)\">\n" +
                "\t\t\t\t</div>\n" +
                "\t\t\t</td>\n" +
                "\t\t</tr>";
            //var table = document.createElement('div');
            


            

            meat.appendChild(table);
            money[i].innerText = meat_List[i].goods_price;
            //images[i].src = "../NewConsume_mealticket/" + meat_List[i].PicPath;
            //images[i].src = "../NewJMConsume/" + meat_List[i].PicPath;
            images[i].src = "http://183.240.150.216:9230/NewJMConsumeYDSJL/" + meat_List[i].PicPath;
            names[i].innerText = meat_List[i].goods_name;
            names[i].title = meat_List[i].postID;

            //time[i].innerText = meat_List[i].getgoods_end.replace('T',' ');
            kg[i].innerText = meat_List[i].unit;


            //预定倒计时
            let book_start = meat_List[i].book_start.replace(/-/g, "/").replace(/T/g, " ");
            let start = new Date(book_start).getTime();
            let book_end = meat_List[i].book_end.replace(/-/g, "/").replace(/T/g, " ");
            let end = new Date(book_end).getTime();
            let nowDate = getNowFormatDate();
            let now = new Date(nowDate).getTime();

            //离正式开售时间
            let getgoods_start = meat_List[i].getgoods_start.replace(/-/g, "/").replace(/T/g, " ");
            let start_2 = new Date(getgoods_start).getTime();
            let getgoods_end = meat_List[i].getgoods_end.replace(/-/g, "/").replace(/T/g, " ");
            let end_2 = new Date(getgoods_end).getTime();
            //let djsArr = [];
            //let djsArr_2 = [];
            if (start <= now && now < end) {
                //console.log("daojishi倒计时", start, now, end);
                //djsArr.push({ time: book_end });
                //daojishi(djsArr, meat, i);
                let txt = meat.getElementsByClassName('txt');
                txt[i].className = 'txt txt2'
                txt[i].innerHTML = '预订倒计时';
                txt[i].parentNode.className = 'yd counttime1';
                //倒计时
                let time = meat.getElementsByClassName('time');
                time[i].id = ids + i;
                countTime(time[i].id, book_end)


            } else if (now <= start_2 && now >= end) {
                //console.log("购买时间倒计时", end, now, start_2);
                //djsArr_2.push({ time: getgoods_start });
                //daojishi(djsArr_2, meat, i);
                let txt = meat.getElementsByClassName('txt');
                txt[i].className = 'txt txt2'
                txt[i].innerHTML = '离正式开售时间';
                txt[i].parentNode.className = 'yd counttime2';
                //离正式开售时间
                let time = meat.getElementsByClassName('time');
                time[i].id = ids + i;
                countTime(time[i].id, getgoods_start)

            } else if (now >= start_2 && now <= end_2) {
                let txt = meat.getElementsByClassName('txt');
                txt[i].className = 'txt'
                txt[i].innerHTML = '可购买';
                txt[i].parentNode.className = 'yd counttime1';
                let time = meat.getElementsByClassName('time');
                time[i].innerHTML = '';
            } else {
                let txt = meat.getElementsByClassName('txt');
                txt[i].className = 'txt txt2'
            }

        }

        function counttime(type) {

        }

        //获取网络时间
        function getNowFormatDate() {
            var currentdate;

            $.ajax({
                type: 'GET',
                dataType: 'json',
                async: false,
                url: 'http://quan.suning.com/getSysTime.do',
                success: function (data) {
                    var data = data.sysTime2;
                    currentdate = data.slice(0, 16);
                }
            })
            //alert(currentdate);
            return currentdate.replace(/-/g, "/");
           
        }
        //新倒计时方法
        function countTime(key, date) {
            console.log('aaa', key, date)
            setInterval(function () {
                //console.log('111', key, date, DownTime(date))
                document.getElementById(key).innerHTML = DownTime(date)
            }, 1000);
        }
        
        function daojishi(array, type, index) {
            var set = setInterval(function () {
                array.map(function (v, index) {
                    var date = timer(v.time);
                    var day = date.days;
                    var hours = date.hours;
                    var min = date.minutes;
                    var sec = date.seconds;
                    //判断时间有没有为0
                    if (date.days <= 0 && date.hours <= 0 && date.minutes <= 0 && date.seconds <= 0) {
                        v.str = "00:00:00"
                        //设置一个标志，如果全部为0，就可以关闭计时器
                        v.realtime = 0;
                        let flag = array.every(function (val, ind) { //苹果不兼容箭头函数
                            return val.realtime == 0
                        })
                        if (flag) {
                            clearInterval(set)
                        }
                    } else {
                        if (hours < 10) {
                            hours = '0' + hours;
                        }
                        if (min < 10) {
                            min = '0' + min;
                        }
                        if (sec < 10) {
                            sec = '0' + sec;
                        }
                        v.str = hours + ":" + min + ":" + sec
                    }
                })
                // 这里拿到的array就会时刻更新
                //console.log(array)

                for (let i = 0; i < array.length; i++) {
                    var time = type.getElementsByClassName('time');
                    time[index].innerText = array[i].str;

                    ////样式
                    for (let j = 0; j < time.length; j++) {
                        if (time[j].innerText == '') {
                            time[j].parentNode.style.display = 'none';
                            time[j].parentNode.parentNode.firstChild.className = 'recive_p';
                            //console.log("样式", time[index].parentNode)
                        }
                    }


                }

                return array;
            }, 1000);
        }

        function jia(obj) {
            console.log("加", obj.parentNode.parentNode.firstChild.getElementsByClassName('time')[0]);
            console.log("counttime", obj.parentNode.parentNode.firstChild)
            let yd = obj.parentNode.parentNode.firstChild;
            //let t = obj.parentNode.parentNode.firstChild.getElementsByClassName('time')[0].innerText;

            //if (!t) {
            //    alert('所选商品不在下单时间内！')
            //    return;
            //}
            if (yd.className == 'yd counttime2') {
                alert('所选商品不在下单时间内！')
                return;
            }
            let countInput = obj.parentNode.getElementsByTagName("input")[1];
            countInput.value++;
            //console.log("this", countInput, countInput.value);
        }
        function jian(obj) {
            let countInput = obj.parentNode.getElementsByTagName("input")[1];
            if (countInput.value >= 1) {
                countInput.value--;
            }
        }
        //旧倒计时方法
        function timer(DateStr) {
            alert('daojishi');
            var date = {};
            //结束时间
            var endDate = new Date(DateStr);
            //当前时间
            var nowDate = new Date();
            //相差的总秒数
            var totalSeconds = parseInt((endDate - nowDate) / 1000);
            //天数
            var days = Math.floor(totalSeconds / (60 * 60 * 24));
            //取模（余数）
            var modulo = totalSeconds % (60 * 60 * 24);
            //小时数
            var hours = Math.floor(modulo / (60 * 60));
            modulo = modulo % (60 * 60);
            //分钟
            var minutes = Math.floor(modulo / 60);
            //秒
            var seconds = modulo % 60;
            date = {
                days: days,
                hours: hours,
                minutes: minutes,
                seconds: seconds,
            }
            return date
        }

    </script>
    <!--swiper菜单-->
    <script src="Scripts/swiper.min.js" type="text/javascript"></script>
    <script>

        function swiper() {
            var swiper = new Swiper('.swiper-container', {
                slidesPerView: 5,
                spaceBetween: 30,
                freeMode: true,
                //pagination: {
                //  el: '.swiper-pagination',
                //  clickable: true,
                //},
            });
        }



    </script>
</body>

</html>

